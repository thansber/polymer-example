<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="devices-api">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
       auto
       url="devices.json"
       handle-as="json"
       last-response="{{ devicesResponse }}"></iron-ajax>

  </template>
  <script>
  (function() {

    var IGNORED_GROUP = '__ignore__';

    var deviceGroupMapping = {
      camera: {
        group: 'camera',
        path: 'cameras'
      },
      cameraMotion: {
        group: IGNORED_GROUP
      },
      doorLock: {
        group: 'lock',
        path: 'locks'
      },
      light: {
        group: 'light',
        path: 'lights'
      },
      lightSwitch: {
        group: 'light',
        path: 'lights'
      },
      lightDimmer: {
        group: 'light',
        path: 'lights'
      },
      lock: {
        group: 'lock',
        path: 'locks'
      },
      panel: {
        group: 'panel',
        path: 'panels'
      },
      peripheral: {
        group: 'peripheral',
        path: 'peripherals'
      },
      sensor: {
        group: 'sensor',
        path: 'sensors'
      },
      thermostat: {
        group: 'thermostat',
        path: 'thermostats'
      }
    };

    Polymer({
      is: 'devices-api',
      properties: {
        devicesResponse: Object,
        devices: {
          notify: true,
          type: Array
        },
        deviceIds: {
          notify: true,
          type: Object
        }
      },

      observers: [
        '_parseDeviceResponse(devicesResponse)',
        '_parseDeviceIds(devices)'
      ],

      _parseDeviceIds: function(devices) {
        var deviceIds = {
          all: [],
          cameras: {
            all: []
          },
          lights: {
            all: []
          },
          locks: {
            all: []
          },
          panels: {
            all: []
          },
          peripherals: {
            all: []
          },
          sensors: {
            all: []
          },
          thermostats: {
            all: []
          }
        };
        devices.forEach(function(device) {
          var mapping = deviceGroupMapping[device.deviceType];
          deviceIds.all.push(device.id);

          if (mapping && mapping.path) {
            deviceIds[mapping.path].all.push(device.id);
          }
        });
        this.set('deviceIds', deviceIds);
      },

      _parseDeviceResponse: function(response) {
        var devices = response._embedded.devices;
        devices.forEach(function(device) {
          var mapping = deviceGroupMapping[device.deviceType];
          if (mapping) {
            device.group = mapping.group;
          }
        });
        this.set('devices', devices);
      }
    });
  }());
  </script>
</dom-module>