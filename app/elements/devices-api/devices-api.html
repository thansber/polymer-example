<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="devices-api">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
       auto
       url="devices.json"
       handle-as="json"
       last-response="{{ devicesResponse }}"></iron-ajax>

  </template>
  <script>
  (function() {

    var IGNORED_GROUP = '__ignore__';

    var deviceTypeMapping = {
      camera: {
        group: 'camera',
        path: 'cameras'
      },
      cameraMotion: {
        group: IGNORED_GROUP
      },
      doorLock: {
        group: 'lock',
        path: 'locks'
      }/*,
      light: 'light',
      lightSwitch: 'light',
      lightDimmer: 'light',
      lock: 'lock',
      panel: 'panel',
      peripheral: 'peripheral',
      sensor: 'sensor',
      thermostat: 'thermostat'*/
    };

    Polymer({
      is: 'devices-api',
      properties: {
        devicesResponse: Object,
        world: {
          notify: true,
          type: Object,
          value: function() {
            return {
              cameras: {
                all: []
              },
              devices: {
                all: []
              },
              lights: {
                all: []
              },
              locks: {
                all: []
              },
              sensors: {
                all: []
              }
            };
          }
        }
      },

      observers: [
        '_devicesChanged(world.devices.all)',
        '_parseDeviceResponse(devicesResponse)'
      ],

      _devicesChanged: function(devices) {
        (devices || []).forEach(function(device) {
          var mapping = deviceTypeMapping[device.deviceType];
          if (mapping && mapping.group !== IGNORED_GROUP) {
            this.push('world.' + mapping.path + '.all', device);
          }
        }, this);
      },

      _parseDeviceResponse: function(response) {
        this.set('world.devices.all', response._embedded.devices);
      }
    });
  }());
  </script>
</dom-module>